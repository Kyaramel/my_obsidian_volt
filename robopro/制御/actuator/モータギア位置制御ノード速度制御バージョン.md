# 📋 基本情報

- **パッケージ名**: `gear_speed_control_vel`
- **優先度**: `中`
- **予定工数**: `3日`

# 🎯 パッケージ概要

## 目的

外部からの指令に基づき、モータを特定の速度で駆動し、外部から**キャンセルされるまで**その速度を維持するノード。本ノードは、以前の位置制御ノードとActionインターフェースを統一することで、上位ノードの変更を最小限に抑えることを目的とする。

## 主要機能

- **速度指令の受信**: Action Goalとして目標速度 [rad/s] を取得する。
- **継続的な駆動**: Actionがキャンセルされるまで、`/sabacan_robomas_ref...` に**速度制御モード**（`control_type = "speed"`）と**目標速度**を継続的に送信する。
- **キャンセル時の停止**: Actionがキャンセルされたら、モータ駆動ノードに**停止指令**（例：アイドルモード）を送信する。
- **フィードバック**: モータの現在の移動位置[mm]をAction Feedbackとして送信する。
- **必要なパラメータ**: 制御モータボードID、モータ番号、制御周期[Hz]。

# 📡 通信仕様

## パブリッシュするトピック

- **トピック名**: `/sabacan_robomas_ref<board_id>/motor<motor_number>`
- **メッセージ型**: `sabacan_single_control_msgs/msg/sabacan_robomas_single_ref`
- **説明**: `モータの指令値`
- **頻度**: `control_frequency_hz` [Hz]

## サブスクライブするトピック

- **トピック名**: `/sabacan_robomas_status<board_id>`
- **メッセージ型**: `sabacan_msgs/msg/sabacan_robomas_status`
- **説明**: モータの角度フィードバックを取得
- **用途**: 速度フィードバックを抽出

## サービス

- **注意**: この速度制御ノードはリセット処理を行わないため、サービス機能は**不要**です。ただし、**インターフェースの統一**のため、将来のリセット処理に対応できるよう、以下の定義を仮に残します。（今回は使用しない）
- **サービス名**: `/gear_position_control_reset/board<board_id>/motor<motor_number>`
- **メッセージ型**: `std_srvs::srv::Trigger`
- **説明**: リセットフラグ
- **用途**: **（本ノードでは使用しない）**

## アクション

- **Action名を維持することで、上位ノードの変更を回避します。**
- **アクション名**: `/gear_position_control_ref_mm/board<board_id>/motor<motor_number>`
    - **ファイル名**: `GearPositionControl.action`
    - **説明**: モータを**指定速度で駆動し、キャンセルされるまで維持**する。
    - **Goal**: `std_msgs/Float32` **目標位置** [rad/s]
    - **Result**: `std_msgs/Float32` 最終的な到達**位置** [mm]
    - **Feedback**: `std_msgs/Float32` 移動中の現在**位置** [mm]

# ⚙️ パラメータ

- **`board_id`**
    - **型**: `int`
    - **デフォルト値**: 0
    - **説明**: モータボードID
- **`motor_number`**
    - **型**: `int`
    - **デフォルト値**: 0
    - **説明**: モータ番号
- **`control_frequency_hz`**
    - **型**: `int`
    - **デフォルト値**: 10
    - **説明**: 制御周期
- `gear_size`
	- 型: float
	- デフォルト値: 50.0
	- 用途: ギアの直径[mm]

# 作業指示

- まず、最初にパッケージのディレクトリ構造と、メインの処理の構成を提示すること
- メインの処理について、どのような関数を作成し、どういう処理を実行するのか説明すること
- これらの設計構想を確認し、受理されるまでパッケージやノードは作成しないこと
- 受理され次第、実装作業を行い、完成したら教えてください
- colcon buildの指示がされたら、指定されたディレクトリでビルドを実行すること
- エラーが発生した場合は、まず、どういうエラーが発生したのかエラーコードを解析し、何が原因なのか特定すること
- 問題の原因が特定でき次第、修正作業を行うこと
- nodeの主要な処理を、ROS2のapi依存部と、純粋な計算部に明確に分離させること
	- ノードクラス
		- action, subscriber, publisher, timerなどのインスタンス化とROS2 apiの呼び出しのみを担当
		- ROS2のコールバック関数をシンプルに保つこと
	- ロジックの分離
		- ノードクラスとは別に、独立したstaticなヘルパー関数を定義すること
	- 状態管理
		- モータの現在角度、目標速度などの内部状態は、ノードクラス内のプライベートなメンバ変数で管理すること
	- コードの配置
		- 計算ロジックやヘルパークラスの定義は、メインのnodeファイル内に直接定義せず、別のヘッダファイルに配置してください
	- デバッグ
		- RCLCPP_INFOなどを使用して、容易にデバッグが行えるようにしてください
	- テスト
		- 一応ros2 testが行えるようにしてください
# 📝 ドキュメント要件

- `[ ] README.md作成`
- `[ ] 使用例（動作確認用のコマンド）`
- `[ ] プログラム内のすべての関数に日本語でコメントをつける`

