
# 📋 基本情報
- **パッケージ名**: `noda_chassis`
- **優先度**: `高`
- **予定工数**: `2025/10/31` (変更なし)

# 🎯 パッケージ概要

## 目的

R2 野田足回り昇降機構を制御するパッケージおよびノード（最下面からの距離制御を担当）

## 主要機能

- **高レベル指令の受信**: `/noda_chassis_ref<chassis_number>`で最下面からの目標距離[mm]を受信。
- **モータ制御の委譲**: 受信した目標距離をGoalとして`/gear_position_control_ref_mm/...` Actionクライアントに送信。
- **リミットスイッチの監視**: `sabacan_gpio_node`から最上面・最下面のフォトインタラプタ信号を受信し、**起動時の位置合わせ**と**安全停止**に使用。
- **初期位置合わせ**: 起動した最初に、最下面のフォトインタラプタが反応するまでモータを下げ、反応した時点で**Actionをキャンセル**し、**リセットServiceを呼び出す**ことで、その位置をゼロ点として設定する。
- **ノードの多重実行**: 最終的には足の数だけこのノードを実行し、各足の昇降高さを個別に制御する。

# 📡 通信仕様

## パブリッシュするトピック

- なし。 (モータ指令はActionを通じて`gear_position_control_node`に送られるため、このノードからは直接パブリッシュしません。)
    

## サブスクライブするトピック

- **トピック名**: `/sabacan_gpio_res<gpio_board_id>`
    
    - **メッセージ型**: `sabacan_msgs/msg/sabacan_gpio_res`
        
    - **説明**: GPIOボードのフィードバック（フォトインタラプタ）
        
    - **用途**: **ホーミング**と**安全リミット**の検知
        
- **トピック名**: `/noda_chassis_ref<chassis_number>`
    
    - **メッセージ型**: `std_msgs/msg/Float32`
        
    - **説明**: 最下面からの目標上昇高さ
        
        $$mm$$
    - **用途**: 高レベルな移動指令
        

## サービス

- **サービス名**: `/gear_position_control_reset/board<robomas_board_id>/motor<motor_number>`
    
    - **メッセージ型**: `std_srvs::srv::Trigger`
        
    - **説明**: モータ角の**ゼロ点リセット**指令を送信
        
    - **用途**: 起動時の**位置合わせ処理**に必須
        

## アクション

- **アクション名**: `/gear_position_control_ref_mm/board<robomas_board_id>/motor<motor_number>`
    
    - **ファイル名**: `GearPositionControl.action`
        
    - **Goal**: `std_msgs/Float32` 目標距離
        
        $$mm$$
    - **Result**: `std_msgs/Float32` 最終到達位置
        
        $$mm$$
    - **Feedback**: `std_msgs/Float32` 現在位置
        
        $$mm$$
    - **用途**: モータを指定位置まで移動させる
        

# ⚙️ パラメータ

- **`robomas_board_id`**
    
    - **型**: `int`
        
    - **デフォルト値**: `0`
        
    - **説明**: 制御モータボード ID
        
- **`motor_number`**
    
    - **型**: `int`
        
    - **デフォルト値**: `0`
        
    - **説明**: 制御するモータの ID
        
- **`gpio_board_id_bottom`**
    
    - **型**: `int`
        
    - **デフォルト値**: `0`
        
    - **説明**: **最下面**フォトインタラプタが接続された GPIO ボードの ID
        
- **`gpio_board_id_top`**
    
    - **型**: `int`
        
    - **デフォルト値**: `1`
        
    - **説明**: **最上面**フォトインタラプタが接続された GPIO ボードの ID
        
- **`pin_number_bottom`**
    
    - **型**: `int`
        
    - **デフォルト値**: `0`
        
    - **説明**: **最下面**フォトインタラプタのピン番号
        
- **`pin_number_top`**
    
    - **型**: `int`
        
    - **デフォルト値**: `1`
        
    - **説明**: **最上面**フォトインタラプタのピン番号
        
- **`chassis_number`**
    
    - **型**: `int`
        
    - **デフォルト値**: `0`
        
    - **説明**: 野田足の番号
        
- **`max_stroke_mm`**
    
    - **型**: `float`
        
    - **デフォルト値**: `300.0`
        
    - **説明**: 機構の**最大昇降ストローク**
        
        $$mm$$
        
        （指令値の制限に使用）
        
- **`homing_speed_mm`**
    
    - **型**: `float`
        
    - **デフォルト値**: `-50.0`
        
    - **説明**: 起動時**位置合わせ**（ホーミング）に使用する速度
        
        $$mm/s$$
        
        （下げ方向のGoal値として使用）
        

# 📝 ドキュメント要件

- `[ ] README.md作成`
    
- `[ ] 使用例（動作確認用のコマンド）`
    
- `[ ] プログラム内のすべての関数にコメントをつける`